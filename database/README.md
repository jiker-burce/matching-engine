# 交易系统数据库设计

## 🗄️ 数据库选择

### 主数据库：PostgreSQL + TimescaleDB
- **用途**：存储订单、用户、账户等核心业务数据
- **优势**：ACID支持、事务一致性、时间序列优化
- **适用场景**：订单管理、用户管理、账户余额

### 分析数据库：ClickHouse（可选）
- **用途**：存储交易历史、市场数据、统计分析
- **优势**：极高性能、压缩率高、分析查询优化
- **适用场景**：交易历史、市场数据分析、报表

## 📊 数据表设计

### 核心业务表
1. **users** - 用户表
   - 存储用户基本信息
   - 支持用户认证和权限管理

2. **accounts** - 账户表
   - 存储用户资产余额
   - 支持多币种账户

3. **trading_pairs** - 交易对表
   - 定义支持的交易对
   - 配置交易规则和精度

4. **orders** - 订单表
   - 存储所有订单信息
   - 支持时间序列分区（TimescaleDB）

5. **trades** - 交易表
   - 存储成交记录
   - 支持时间序列分区（TimescaleDB）

### 市场数据表
6. **market_data** - 市场数据表
   - 存储实时价格和统计数据
   - 支持时间序列分区

7. **orderbook_snapshots** - 订单簿快照
   - 存储历史订单簿状态
   - 用于回放和分析

## 🚀 部署建议

### 开发环境
```bash
# 使用 Docker Compose
docker-compose up -d postgres timescaledb
```

### 生产环境
- **主从复制**：确保数据高可用
- **读写分离**：提高查询性能
- **分片策略**：按交易对或时间分片
- **备份策略**：定期备份和恢复测试

## 📈 性能优化

### 索引策略
- **订单表**：按用户ID、交易对、状态、时间建立复合索引
- **交易表**：按交易对、时间建立索引
- **市场数据**：按交易对、时间建立索引

### 分区策略
- **时间分区**：按月或按周分区
- **交易对分区**：热门交易对独立分区
- **数据生命周期**：定期清理历史数据

### 查询优化
- **连接池**：使用连接池管理数据库连接
- **查询缓存**：缓存频繁查询的结果
- **读写分离**：分析查询使用只读副本

## 🔧 配置示例

### PostgreSQL 配置
```sql
-- 连接数配置
max_connections = 200
shared_buffers = 256MB
effective_cache_size = 1GB

-- 时间序列优化
timescaledb.max_background_workers = 4
timescaledb.max_worker_processes = 4
```

### 连接字符串
```
postgresql://username:password@localhost:5432/trading_engine
```

## 📊 监控指标

### 关键指标
- **TPS**：每秒事务数
- **QPS**：每秒查询数
- **连接数**：活跃连接数
- **锁等待**：锁等待时间
- **慢查询**：执行时间超过阈值的查询

### 告警设置
- **连接数告警**：超过80%时告警
- **慢查询告警**：超过1秒的查询
- **锁等待告警**：超过100ms的锁等待
- **磁盘空间告警**：超过85%时告警

## 🔄 数据迁移

### 从模拟数据迁移
1. **用户数据**：创建默认用户和账户
2. **交易对**：添加支持的交易对
3. **历史数据**：导入模拟的交易数据
4. **市场数据**：初始化市场数据

### 数据一致性
- **事务支持**：确保订单和账户数据一致性
- **并发控制**：使用乐观锁或悲观锁
- **数据校验**：定期检查数据完整性
